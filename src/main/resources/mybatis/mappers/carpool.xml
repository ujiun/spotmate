<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="carpool">

	<!-- 탑승 가능 차량 리스트 (추가:탑승가능인원수에 맞게 리스트 체킹, 페이징 css 가운데 정렬,  )-->
	
	<select id="selectCarpoolList" parameterType="map" resultType="com.spotmate.vo.CarpoolVo">
		<![CDATA[
			select se.rn,
				   sm.no,
			       sm.type,
			       se.splace,
			       se.eplace,
			       sm.point,
			       u.id
			from spotmate sm, car c, users u,
			     (select rownum rn,
			     	     s.sMateNo,
			             s.splace,
			             e.eMateNo,
			             e.ePlace
			      from (select p.mateNo sMateNo, p.place sPlace
			            from place p
			            where p.wayNo = -1) s,
			           (select p.mateNo eMateNo, p.place ePlace
			            from place p
			            where p.wayNo = 0) e
			      where s.sMateNo = e.eMateNo) se
			where sm.no = se.sMateNo
			and c.no = sm.carNo
			and u.no = c.userNo
			and rn>=#{startRnum}
			and rn<=#{endRnum}
		
		]]>	
		
		<if test="value != ''  and  value != null ">
			and splace like '%'||#{value}||'%'
		</if>	
		
		<if test="value != ''  and  value != null ">
			and eplace like '%'||#{value}||'%'
		</if>	
		
			
		<![CDATA[	
			order by sm.no asc
		]]>
					
	</select>
	
		
	
	<!-- 차량 리스트 전체 글 갯수 -->
	<select id="totalCarpoolCnt" resultType="int">
		<![CDATA[
			select count(*) count
			from spotmate sm, car c, users u,
				 (select rownum rn,
			     	     s.sMateNo,
			             s.splace,
			             e.eMateNo,
			             e.ePlace
			      from (select p.mateNo sMateNo, p.place sPlace
			            from place p
			            where p.wayNo = -1) s,
			           (select p.mateNo eMateNo, p.place ePlace
			            from place p
			            where p.wayNo = 0) e
			      where s.sMateNo = e.eMateNo) se
			where sm.no = se.sMateNo
			and c.no = sm.carNo
			and u.no = c.userNo
		]]>
	
	</select>
	
		
	<!-- 리뷰 리스트 (추가: 드라이버의 평균 별점 계산)-->
	
	<select id="selectReviewlist" resultType="CarpoolVo">
		<![CDATA[
			select 
				u.id,
				w.star,
				w.content
			from users u, reservation r, userReview w
			where u.no = r.driverNo
			and r.no = w.resvNo 			
		]]>
		
	</select>
	
	<!--  SELECT PRODUCT_NO, ROUND(AVG(REPLY_STAR),1)
FROM REPLY 
GROUP BY PRODUCT_NO;-->
	
	<!-- Deep 차량 추천 리스트 박스  -->
	
	<select id="selectRecommendList" resultType="com.spotmate.vo.CarpoolVo">
		<![CDATA[
			select u.id,
			       to_char(sm.startDate, 'yyyy-mm-dd') startDate,
			       sm.point
			     
			from spotmate sm, car c, users u,
			     (select s.sMateNo,
			             s.splace,
			             e.eMateNo,
			             e.ePlace
			      from (select p.mateNo sMateNo, p.place sPlace
			            from place p
			            where p.wayNo = -1) s,
			           (select p.mateNo eMateNo, p.place ePlace
			            from place p
			            where p.wayNo = 0) e
			      where s.sMateNo = e.eMateNo) se
			where sm.no = se.sMateNo
			and c.no = sm.carNo
			and u.no = c.userNo


		]]>
		
	</select>
	
	
	
	<!-- 드라이버 차량 정보 가져오기 -->
	
	<select id="selectDriverInfo" resultType="CarpoolVo">
		<![CDATA[
			select 
				u.id,
				c.carName,
				c.carPicture,
				c.introduce,
				s.comments,
				o.name
			from users u, car c, spotmate s, spotDetail d, detailOption o
			where u.no = c.userNo
			and c.no = s.carNo 	
			and s.no = d.mateNo
			and o.no = d.detailNo	
			and u.no = #{no}	
		]]>
		
		
	</select>
	
	
</mapper>	