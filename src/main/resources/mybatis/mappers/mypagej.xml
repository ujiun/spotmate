<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="mypagej">

	<!-- 쿠폰리스트가져오기 -->
	<select id="selectCouponBList" parameterType="map" resultType="couponVo">
		<![CDATA[
			select  ort.rn,
			        ort.no,
			        ort.buyDate,
			        ort.usePlace,
			        ort.point,
			        ort.name,
			        ort.status
			    from (select  rownum rn,
			                  ot.no,
			                  ot.buyDate,
			                  ot.usePlace,
			                  ot.point,
			                  ot.name,
			                  ot.status
			            from (select  cu.no no,
			                          to_char(cu.buyDate, 'yy.mm.dd') buyDate,
			                          cu.usePlace,
			                          cu.point point,
			                          ca.name,
			                          cu.status
			                    from category ca, brand br, coupon co, couponUsage cu, users u
			                    where u.no = cu.userno
			                    and ca.no = br.cateNo
			                    and br.no = co.brandno
			                    and co.no = cu.couponNo
			                    and u.no = #{userNo}
			                    order by cu.no desc)ot
			              )ort
			where rn>=#{startRnum}
			and rn<=#{endRnum}
		]]>

		<if test="endDate != '' and endDate != null">
			and #{endDate} >= ort.buyDate
		</if>

		<if test="startDate != '' and startDate != null">
			and ort.buyDate >= #{startDate}
		</if>

		<if test="option2 != '' and option2 != null">
			and ort.status = #{option2}
		</if>

		<if test="option1 != '' and option1 != null">
			and ort.name = #{option1}
		</if>

	</select>


	<!-- 포인트충전 -->
	<insert id="insertPoint" parameterType="pointVo">
		<![CDATA[
			INSERT INTO pointUsage
			VALUES (SEQ_POINTUSAGE_NO.nextval, #{userNo}, '충전', sysdate, #{point}, #{point}, null)
		]]>
	</insert>


	<!-- 쿠폰리스트전체글 갯수 -->
	<select id="totalCouponCnt" parameterType="int" resultType="int">
		<![CDATA[
			select count(*) count
			from category ca, brand br, coupon co, couponUsage cu, users u
			where u.no = cu.userno
			and ca.no = br.cateNo
			and br.no = co.brandno
			and co.no = cu.couponNo
			and u.no = #{userNo}
		]]>

	</select>

	<!-- 쿠폰상품리스트 -->
	<select id="selectCouponList" parameterType="map" resultType="CouponVo">
		<![CDATA[
			select co.no couponNo,
                   imgsrc
			from category ca, brand br, coupon co
			where  ca.no = br.cateNo
			and br.no = co.brandno
		]]>
		
		<if test="maxValue != '' and maxValue != null">
		and #{maxValue} >= point
		</if>
		
		<if test="minValue != '' and minValue != null">
		and point >= #{minValue}
		</if>
		
		<if test="option1 != '' and option1 != null">
			and ca.name = #{option1}
		</if>
		
		<if test="option2 != '' and option2 != null">
		and br.name = #{option2}
		</if>
		
	</select>

	<!-- 쿠폰이미지가져오기 -->
	<select id="selectCouponImg" parameterType="int" resultType="CouponVo">
		<![CDATA[
			select  no couponNo,
      				point,
      				imgsrc
			from coupon
			where no = #{couponNo}
		]]>
	</select>

	<!-- 포인트리스트가져오기 -->
	<select id="selectPointList" parameterType="int" resultType="PointVo">
		<![CDATA[
			select  ort.rn,
			        ort.no,
			        ort.type,
			        to_char(ort.regDate, 'yy.mm.dd') regDate,
			        ort.splace,
			        ort.eplace,
			        ort.point
			from (select rownum rn,
			             ot.no,
			             ot.type,
			             ot.regdate,
			             ot.splace,
			             ot.eplace,
			             ot.point
			      from (select  no,
			                    type,
			                    regDate,
			                    splace,
			                    eplace,
			                    point
			            from  (select  u.no no,
			                           sp.type,
			                           pu.regDate,
			                           pu.type ptype,
			                           se.splace,
			                           se.eplace,
			                           pu.point
			                   from spotmate sp, reservation re, pointUsage pu, users u,
			                        (select sno,
			                                smateno,
			                                sday,
			                                splace,
			                                eno,
			                                emateno,
			                                eday,
			                                eplace
			                         from (select p.no sNo,
			                                      mp.mateNo sMateNo,
			                                      p.day sDay,
			                                      p.place sPlace
			                               from place p,
			                                    (select mateNo, min(day) minDay
			                                     from place
			                                     where wayNo = -1 
			                                     group by mateNo) mp
			                                where p.mateno = mp.mateno
			                                and p.day = mp.minDay
			                                and p.wayNo= -1) s, 
			                              
			                                (select p.no eNo,
			                                        mp.mateNo eMateNo,
			                                        p.day eDay,
			                                        p.place ePlace
			                                 from place p,
			                                     (select mateNo, max(day) maxDay
			                                      from place
			                                      where wayNo = 0 
			                                      group by mateNo) mp
			                                 where p.mateno = mp.mateno
			                                 and p.day = mp.maxDay
			                                 and p.wayNo =0) e
			                         where s.sMateNo = e.eMateNo)se
			                   where sp.no = se.sMateNo
			                   and re.mateno = sp.no
			                   and pu.reno = re.no
			                   and u.no = pu.userno
			                   and u.no = #{userNo}
			                   and pu.type = '완료'
			                
			                   union 
			                
			                   select  userno no,
			                           type,
			                           regdate,
			                           null ptype,
			                           null splace,
			                           null eplace,
			                           point        
			                   from pointUsage
			                   where userno = #{userNo}
			                   and (type = '충전' or type='환불' or type='구매')
			                   )
			            order by regDate desc)ot
			        )ort
		]]>

	</select>
	
	<!-- 총 포인트 가져오기 -->
	
	<select id="selectTotalPoint" parameterType="int" resultType="int">
		<![CDATA[
			select sum(point)
			from pointUsage
			where userno = #{userNo}
		]]>
	
	</select>

</mapper>