<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="spotmate">


	<select id="selectdriverinfo" resultType="String">
		select introduce
		from car
		where no = 2
	</select>
	
	<select id="updatepeople" parameterType="int" resultType="int">
		select people
		from reservation
		where mateNo = #{mateNo}
	</select>
	
	<select id="nowaddr" parameterType="int" resultType="String">
		select latlng
		from place
		where mateNo = #{mateNo}
		and wayno = 0
	</select>
	
	<select id="selectnear" parameterType="int" resultType="hVo">
		select latlng,
			s.no mateNo,
			r.people
		from place p, reservation r, spotmate s
		where wayno = 0
		and p.mateno = r.mateno
        and s.no = p.mateno
        and s.no = r.mateno
		and status = 'open'
        and type = 'hitchhike'
        and r.people > 0
        order by s.no desc
	</select>
	
	<select id="selecthitchdriverinfo" parameterType="int" resultType="hVo">
		select LISTAGG(place, ',') within group (order by wayno asc) as fullPlace,
		    r.point point,
		    comments,
		    round(star, 1) star,
		    name,
		    detailOpt
		from spotmate s, place p, reservation r, 
		(select dn.driverno,
			avg(star) star
		from reservation r, (select 
		                        resvno,
		                        avg(star) star
	                        from userreview
	                        group by resvno
	                        order by resvno asc) re, ( select driverNo
														from reservation
														where mateNo = #{mateNo} ) dn
		where r.no = re.resvno
		and dn.driverno = r.driverno
		group by r.driverno, dn.driverno) dn, ( select LISTAGG(name, ',') within group (order by name asc) as detailopt
					                            from spotdetail sd, detailopt d
					                            where mateNo = #{mateNo}
					                            and sd.detailno = d.no ) , ( select name
																			from users u, reservation r
																			where u.no = r.driverNo
																			and r.mateNo = #{mateNo} )
		where s.no = #{mateNo}
		and s.no = p.mateNo
		and r.mateNo = s.no
		group by r.point, comments, detailopt, dn.driverNo, star, name
	</select>
	
	<select id="selectsummarydriverinfo" parameterType="int" resultType="hVo">
		select place eplace1,
	        name,
	        r.people people
		from spotmate s, place p, reservation r, ( select name
		                                            from users u, reservation r
		                                            where u.no = r.driverNo
		                                            and r.mateNo = #{mateNo} )
		where s.no = #{mateNo}
		and s.no = p.mateNo
		and r.mateNo = s.no
		and wayno = 0
		and r.people > 0
	</select>
	
	
	<select id="selecthitchdriverinfonowpos" parameterType="int" resultType="String">
		select latlng
		from place
		where mateNo = #{mateNo}
	</select>
	
	<select id="selectDriverPos" parameterType="mVo" resultType="mVo">
		select latlng addr,
		mateNo
		from place
		where mateNo = #{mateNo}
		and wayno = 0
	</select>
	
	<select id="selecthitchlist" resultType="hVo">
		select s.no mateNo,
		    place eplace1,
		    r.people people,
		    r.point point,
		    latlng
		from reservation r, spotmate s, place p
		where r.mateNo = s.no
		and p.mateNo = s.no
		and wayno = 0
		and r.people > 0
		order by s.no desc
	</select>
	
	<update id="updatereserv" parameterType="hrVo">
		update reservation
		set 
			people = people - #{people},
			regDate = sysdate
		
		where mateNo = #{mateNo}
	</update>
	
	<update id="recoverreserv" parameterType="hrVo">
		update reservation
		set 
			people = #{canRide}
		
		where mateNo = #{mateNo}
	</update>
	
	<update id="watchpos" parameterType="mVo">
		update place
		set 
			latlng = #{lng}||','||#{lat}||','||#{addr}
		where mateNo = #{mateNo}
		and wayno = 0
	</update>
	
	
	<insert id="carpoolinsert" parameterType="dwVo">
	
			<selectKey keyProperty="no" resultType="int" order="BEFORE">
				select seq_spotmate_no.nextval from dual 
			</selectKey>

			insert all
			into spotmate
			values (
				#{no},
				2,
				#{sdate1},
				#{edate1},
				#{people},
				#{type},
				#{intfare},
				#{dur},
				#{dis},
				#{comments}
			)
			<if test='nosmoke != null'>
			into spotDetail
			values (
				seq_spotDetail_no.nextval,
				#{no},
				1
			)
			</if>
			<if test='femaledriver != null'>
			into spotDetail
			values (
				seq_spotDetail_no.nextval,
				#{no},
				2
			)
			</if>
			<if test='pet != null'>
			into spotDetail
			values (
				seq_spotDetail_no.nextval,
				#{no},
				3
			)
			</if>
			<if test='phonecharge != null'>
			into spotDetail
			values (
				seq_spotDetail_no.nextval,
				#{no},
				4
			)
			</if>
			<if test='trunk != null'>
			into spotDetail
			values (
				seq_spotDetail_no.nextval,
				#{no},
				5
			)
			</if>
			into place values (
				seq_place_no.nextval,
				#{no},
				'',
				-1,
				'출발지',
				#{stime1},
				#{splace1},
				#{slat1},
				#{slng1},
				#{latlng1}
			)
			into place 
			values (
				seq_place_no.nextval,
				#{no},
				'',
				0,
				'도착지',
				'',
				#{eplace1},
				#{elat1},
				#{elng1},
				''
			)
			into reservation
			values (
				seq_reservation_no.nextval,
				#{no},
				2,
				1,
				sysdate,
				#{intfare},
				'open',
				#{people}				
			)
			select * from dual
		</insert>
		<insert id="hitchinsert" parameterType="dwVo">
			<selectKey keyProperty="no" resultType="int" order="BEFORE">
				select seq_spotmate_no.nextval from dual 
			</selectKey>

			insert all
			into spotmate
			values (
				#{no},
				2,
				#{sdate1},
				#{sdate1},
				#{people},
				#{type},
				#{intfare},
				#{dur},
				#{dis},
				#{comments}
			)
			into reservation
			values (
				seq_reservation_no.nextval,
				#{no},
				2,
				1,
				sysdate,
				#{intfare},
				'open',
				#{people}				
			)
			<if test='nosmoke != null'>
			into spotDetail
			values (
				seq_spotDetail_no.nextval,
				#{no},
				1
			)
			</if>
			<if test='femaledriver != null'>
			into spotDetail
			values (
				seq_spotDetail_no.nextval,
				#{no},
				2
			)
			</if>
			<if test='pet != null'>
			into spotDetail
			values (
				seq_spotDetail_no.nextval,
				#{no},
				3
			)
			</if>
			<if test='phonecharge != null'>
			into spotDetail
			values (
				seq_spotDetail_no.nextval,
				#{no},
				4
			)
			</if>
			<if test='trunk != null'>
			into spotDetail
			values (
				seq_spotDetail_no.nextval,
				#{no},
				5
			)
			</if>
			into place values (
				seq_place_no.nextval,
				#{no},
				'',
				-1,
				'출발지',
				#{stime1},
				#{splace1},
				#{slat1},
				#{slng1},
				#{latlng1}
			)
			into place 
			values (
				seq_place_no.nextval,
				#{no},
				'',
				0,
				'도착지',
				'',
				#{eplace1},
				#{elat1},
				#{elng1},
				''
			)
			select * from dual
		</insert>
		
		<insert id="mateinsert" parameterType="mwVo">
		
			<selectKey keyProperty="no" resultType="int" order="BEFORE">
				select seq_spotmate_no.nextval from dual 
			</selectKey>
			
			insert all
			
			into spotmate
			values (
				#{no},
				1,
				#{sdate1},
				#{edate1},
				#{people},
				#{type},
				#{intfare},
				'',
				'',
				#{comments}
			)
			into reservation
			values (
				seq_reservation_no.nextval,
				#{no},
				2,
				1,
				sysdate,
				#{intfare},
				'open',
				#{people}				
			)
			<if test='nosmoke != null'>
			into spotDetail
			values (
				seq_spotDetail_no.nextval,
				#{no},
				1
			)
			</if>
			<if test='femaledriver != null'>
			into spotDetail
			values (
				seq_spotDetail_no.nextval,
				#{no},
				2
			)
			</if>
			<if test='pet != null'>
			into spotDetail
			values (
				seq_spotDetail_no.nextval,
				#{no},
				3
			)
			</if>
			<if test='phonecharge != null'>
			into spotDetail
			values (
				seq_spotDetail_no.nextval,
				#{no},
				4
			)
			</if>
			<if test='trunk != null'>
			into spotDetail
			values (
				seq_spotDetail_no.nextval,
				#{no},
				5
			)
			</if>
			into place values (
				seq_place_no.nextval,
				#{no},
				#{day1},
				-1,
				'출발지',
				#{stime1},
				#{splace1},
				#{slat1},
				#{slng1},
				#{latlng1}
			)
			<if test='wplace11 != null'>
			into place 
			values (
				seq_place_no.nextval,
				#{no},
				#{day1},
				1,
				'경유지',
				#{wtime11},
				#{wplace11},
				#{wlat11},
				#{wlng11},
				''
			)
			
			</if>
			
			<if test='wplace12 != null'>
			into place 
			values (
				seq_place_no.nextval,
				#{no},
				#{day1},
				2,
				'경유지',
				#{wtime12},
				#{wplace12},
				#{wlat12},
				#{wlng12},
				''
			)
			</if>
			
			<if test='wplace13 != null'>
			into place 
			values (
				seq_place_no.nextval,
				#{no},
				#{day1},
				3,
				'경유지',
				#{wtime13},
				#{wplace13},
				#{wlat13},
				#{wlng13},
				''
			)
			</if>
			
			<if test='wplace14 != null'>
			into place 
			values (
				seq_place_no.nextval,
				#{no},
				#{day1},
				4,
				'경유지',
				#{wtime14},
				#{wplace14},
				#{wlat14},
				#{wlng14},
				''
			)
			</if>
			
			<if test='wplace15 != null'>
			into place 
			values (
				seq_place_no.nextval,
				#{no},
				#{day1},
				5,
				'경유지',
				#{wtime15},
				#{wplace15},
				#{wlat15},
				#{wlng15},
				''
			)
			</if>
			
			into place 
			values (
				seq_place_no.nextval,
				#{no},
				#{day1},
				0,
				'도착지',
				'',
				#{eplace1},
				#{elat1},
				#{elng1},
				''
			)
			
			<if test='splace2 != null'>
			into place 
			values (
				seq_place_no.nextval,
				#{no},
				#{day2},
				-1,
				'출발지',
				#{stime2},
				#{splace2},
				#{slat2},
				#{slng2},
				#{latlng2}
			)
			</if>
			
			<if test='wplace21 != null'>
			into place 
			values (
				seq_place_no.nextval,
				#{no},
				#{day2},
				1,
				'경유지',
				#{wtime21},
				#{wplace21},
				#{wlat21},
				#{wlng21},
				''
			)
			</if>
			
			<if test='wplace22 != null'>
			into place 
			values (
				seq_place_no.nextval,
				#{no},
				#{day2},
				2,
				'경유지',
				#{wtime22},
				#{wplace22},
				#{wlat22},
				#{wlng22},
				''
			)
			</if>
			
			<if test='wplace23 != null'>
			into place 
			values (
				seq_place_no.nextval,
				#{no},
				#{day2},
				3,
				'경유지',
				#{wtime23},
				#{wplace23},
				#{wlat23},
				#{wlng23},
				''
			)
			</if>
			
			<if test='wplace24 != null'>
			into place 
			values (
				seq_place_no.nextval,
				#{no},
				#{day2},
				4,
				'경유지',
				#{wtime24},
				#{wplace24},
				#{wlat24},
				#{wlng24},
				''
			)
			</if>
			
			
			<if test='wplace25 != null'>
			into place 
			values (
				seq_place_no.nextval,
				#{no},
				#{day2},
				5,
				'경유지',
				#{wtime25},
				#{wplace25},
				#{wlat25},
				#{wlng25},
				''
			)
			</if>
			
			<if test='eplace2 != null'>
			into place 
			values (
				seq_place_no.nextval,
				#{no},
				#{day2},
				0,
				'도착지',
				'',
				#{eplace2},
				#{elat2},
				#{elng2},
				''
			)
			</if>
			
			
			<if test='splace3 != null'>
			into place 
			values (
				seq_place_no.nextval,
				#{no},
				#{day3},
				-1,
				'출발지',
				#{stime3},
				#{splace3},
				#{slat3},
				#{slng3},
				#{latlng3}
			)
			</if>
			
			<if test='wplace31 != null'>
			into place 
			values (
				seq_place_no.nextval,
				#{no},
				#{day3},
				1,
				'경유지',
				#{wtime31},
				#{wplace31},
				#{wlat31},
				#{wlng31},
				''
			)
			</if>
			
			<if test='wplace32 != null'>
			into place 
			values (
				seq_place_no.nextval,
				#{no},
				#{day3},
				2,
				'경유지',
				#{wtime32},
				#{wplace32},
				#{wlat32},
				#{wlng32},
				''
			)
			</if>
			
			<if test='wplace33 != null'>
			into place 
			values (
				seq_place_no.nextval,
				#{no},
				#{day3},
				3,
				'경유지',
				#{wtime33},
				#{wplace33},
				#{wlat33},
				#{wlng33},
				''
			)
			</if>
			
			<if test='wplace34 != null'>
			into place 
			values (
				seq_place_no.nextval,
				#{no},
				#{day3},
				4,
				'경유지',
				#{wtime34},
				#{wplace34},
				#{wlat34},
				#{wlng34},
				''
			)
			</if>
			
			<if test='wplace35 != null'>
			into place 
			values (
				seq_place_no.nextval,
				#{no},
				#{day3},
				5,
				'경유지',
				#{wtime35},
				#{wplace35},
				#{wlat35},
				#{wlng35},
				''
			)
			</if>
			
			<if test='eplace3 != null'>
			into place 
			values (
				seq_place_no.nextval,
				#{no},
				#{day3},
				0,
				'도착지',
				'',
				#{eplace3},
				#{elat3},
				#{elng3},
				''
			)
			</if>
			
			<if test='splace4 != null'>
			into place 
			values (
				seq_place_no.nextval,
				#{no},
				#{day4},
				-1,
				'출발지',
				#{stime4},
				#{splace4},
				#{slat4},
				#{slng4},
				#{latlng4}
			)
			</if>
			
			<if test='wplace41 != null'>
			into place 
			values (
				seq_place_no.nextval,
				#{no},
				#{day4},
				1,
				'경유지',
				#{wtime41},
				#{wplace41},
				#{wlat41},
				#{wlng41},
				''
			)
			</if>
			
			<if test='wplace42 != null'>
			into place 
			values (
				seq_place_no.nextval,
				#{no},
				#{day4},
				2,
				'경유지',
				#{wtime42},
				#{wplace42},
				#{wlat42},
				#{wlng42},
				''
			)
			</if>
			
			<if test='wplace43 != null'>
			into place 
			values (
				seq_place_no.nextval,
				#{no},
				#{day4},
				3,
				'경유지',
				#{wtime43},
				#{wplace43},
				#{wlat43},
				#{wlng43},
				''
			)
			</if>
			
			
			<if test='wplace44 != null'>
			into place 
			values (
				seq_place_no.nextval,
				#{no},
				#{day4},
				4,
				'경유지',
				#{wtime44},
				#{wplace44},
				#{wlat44},
				#{wlng44},
				''
			)
			</if>
			
			<if test='wplace45 != null'>
			into place 
			values (
				seq_place_no.nextval,
				#{no},
				#{day4},
				5,
				'경유지',
				#{wtime45},
				#{wplace45},
				#{wlat45},
				#{wlng45},
				''
			)
			</if>
			
			<if test='eplace4 != null'>
			 into place 
			values (
				seq_place_no.nextval,
				#{no},
				#{day4},
				0,
				'도착지',
				'',
				#{eplace4},
				#{elat4},
				#{elng4},
				''
			)
			</if>
			
			
			<if test='splace5 != null'>
			 into place 
			values (
				seq_place_no.nextval,
				#{no},
				#{day5},
				-1,
				'출발지',
				#{stime5},
				#{splace5},
				#{slat5},
				#{slng5},
				#{latlng5}
			)
			</if>
			
			<if test='wplace51 != null'>
			 into place 
			values (
				seq_place_no.nextval,
				#{no},
				#{day5},
				1,
				'경유지',
				#{wtime51},
				#{wplace51},
				#{wlat51},
				#{wlng51},
				''
			)
			</if>
			
			
			<if test='wplace52 != null'>
			 into place 
			values (
				seq_place_no.nextval,
				#{no},
				#{day5},
				2,
				'경유지',
				#{wtime52},
				#{wplace52},
				#{wlat52},
				#{wlng52},
				''
			)
			</if>
			
			<if test='wplace53 != null'>
			 into place 
			values (
				seq_place_no.nextval,
				#{no},
				#{day5},
				3,
				'경유지',
				#{wtime53},
				#{wplace53},
				#{wlat53},
				#{wlng53},
				''
			)
			</if>
			
			<if test='wplace54 != null'>
			 into place 
			values (
				seq_place_no.nextval,
				#{no},
				#{day5},
				4,
				'경유지',
				#{wtime54},
				#{wplace54},
				#{wlat54},
				#{wlng54},
				''
			)
			</if>
			
			<if test='wplace55 != null'>
			 into place 
			values (
				seq_place_no.nextval,
				#{no},
				#{day5},
				5,
				'경유지',
				#{wtime55},
				#{wplace55},
				#{wlat55},
				#{wlng55},
				''
			)
			</if>
			
			<if test='eplace5 != null'>
			 into place 
			values (
				seq_place_no.nextval,
				#{no},
				#{day5},
				0,
				'도착지',
				'',
				#{eplace5},
				#{elat5},
				#{elng5},
				''
			)
			</if>
			select *
			from dual
			
			
		
			
		
		
		</insert>
		
		
	

</mapper>